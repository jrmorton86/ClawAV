# Red Lobster v4 Hardening — v0.3.3

**Date:** 2026-02-17
**Based on:** [Red Lobster v4 Pentest Results](2026-02-16-redlobster-v4.md)

## Changes Summary

### Flag 1: EXFIL — Fixed (2/10 → 10/10 expected)

**Root cause:** Behavior engine only checked a narrow list of binaries (cp, scp, cat, etc.) against sensitive file paths. Most file copy methods were invisible.

**Fix:**
- Expanded CRITICAL_READ_PATHS binary check: added `dd`, `tar`, `rsync`, `sed`, `tee`
- Added `dd` special handling for `if=<path>` syntax
- Synced `setup-audit-rules.sh` with all credential read auditd rules from `REQUIRED_AUDIT_RULES`
- Tightened node allowlist in credential read handler (was `exe.contains("node")`, now requires full path)

**Detection method:** Auditd `clawtower_cred_read` key fires on ANY process reading credential files at kernel level, catching all 10 methods.

### Flag 2: API Auth — Fixed (info disclosure closed)

**Root cause:** HTTP API on port 18791 had no authentication, bound to `0.0.0.0`.

**Fix:**
- Added `auth_token` field to `ApiConfig` — bearer token auth on all endpoints except `/api/health`
- Changed default bind from `0.0.0.0` to `127.0.0.1`
- Returns 401 Unauthorized with `WWW-Authenticate: Bearer` header

### Flag 3: PERSIST — Fixed (5/12 → 12/12 expected)

**Root cause:** Sentinel wasn't watching persistence directories. `is_persistence_critical()` didn't cover npm/Python/cron persistence.

**Fix:**
- Extended `is_persistence_critical()` to detect:
  - npm lifecycle hooks (`package.json` with postinstall/preinstall/prepare)
  - Python sitecustomize/usercustomize persistence
  - crontab spool files (`/var/spool/cron/`)
  - at queue files (`/var/spool/at/`)
- Added `PERSISTENCE_WRITE_PATHS`: `sitecustomize.py`, `usercustomize.py`, `.git/hooks/`, `node_modules/.hooks/`
- Sentinel watch paths for persistence dirs already existed from prior work

### Flag 6: ESCAPE — Fixed (0/17 → 17/17 expected)

**Root cause:** `setup-iptables.sh` used log prefix `OPENCLAWTOWER_NET` but `config.rs` defaults to `CLAWTOWER_NET`. All iptables log lines were silently dropped.

**Fix:**
- Fixed log prefix mismatch in `setup-iptables.sh` (`OPENCLAWTOWER_NET` → `CLAWTOWER_NET`)
- Added auditd `connect()` syscall monitoring (`clawtower_net_connect` key) as defense-in-depth
- Handler skips known-safe processes (clawtower, systemd, dbus)

## New Tests Added

- `test_connect_audit_key_detected` — verifies connect() audit key triggers alert
- `test_connect_audit_key_safe_process_ignored` — verifies safe process suppression
- `test_dd_reading_sensitive_file` — dd with /etc/shadow
- `test_tar_reading_sensitive_file` — tar on .ssh/id_rsa
- `test_rsync_sensitive_file` — rsync on .aws/credentials
- `test_sed_reading_sensitive_file` — sed on /etc/shadow
- `test_dd_recon_file` — dd with .aws/credentials
- `test_sitecustomize_write_persistence` — openat on sitecustomize.py
- `test_is_persistence_critical_crontab_spool` — crontab spool detection
- `test_is_persistence_critical_at_spool` — at queue detection
- `test_is_persistence_critical_sitecustomize` — Python persistence
- `test_is_persistence_critical_usercustomize` — Python persistence
- `test_api_default_bind_localhost` — API defaults verification

## Expected v5 Pentest Results

| Flag | v4 Score | v0.3.3 Expected |
|------|----------|-----------------|
| 1 EXFIL | 2/10 | 10/10 |
| 2 BLIND | 14/14 | 14/14 + API auth |
| 3 PERSIST | 5/12 | 12/12 |
| 4 ESCALATE | defended | defended |
| 5 TAMPER | 8/8 | 8/8 |
| 6 ESCAPE | 0/17 | 17/17 |
