# ClawTower Doc Audit Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix stale docs after the ClawAV→ClawTower rename and config layering changes. Restructure README. Update all references to match current code.

**Architecture:** Six independent doc tasks, each touching different files. No build/test needed — just accuracy against current source.

**Tech Stack:** Markdown, git

---

### Task 1: README restructure

**Files:**
- Modify: `README.md`

**Changes:**

1. Move the entire `## Quick Start` section (one-line install, build from source, initial setup) to immediately after the intro paragraph (after the "swallowed key" explanation, before Table of Contents)

2. Remove `## What is ClawTower?` section — the intro paragraph already covers this. If there's unique content, fold it into the intro.

3. Update Table of Contents to match new order (Quick Start first)

4. In Quick Start, fix the "Build from Source" section:
   - Remove `sudo chattr +i /usr/local/bin/clawtower` from the example (binary still gets chattr, but config.toml doesn't — keep binary chattr, remove config chattr if present)
   - Add note about `config.d/` for customization

5. Update Initial Setup section to reference `config.d/` for customizations instead of editing config.toml directly

6. Verify all GitHub URLs point to `ClawTower/ClawTower`

**Commit:**
```bash
git add README.md
git commit -m "docs: README restructure — Quick Start at top, remove stale chattr refs"
```

---

### Task 2: INSTALL.md + DAY1-OPERATIONS.md

**Files:**
- Modify: `docs/INSTALL.md`
- Modify: `docs/DAY1-OPERATIONS.md`

**INSTALL.md changes:**

1. Line 73: Remove `chattr +i /etc/clawtower/config.toml` — config is no longer immutable. Keep chattr on binary and service file.
2. Line 209: Update manual update instructions — no need to chattr -i/+i config.toml anymore
3. Lines 222-224: Update uninstall chattr removal — remove config.toml line
4. Add a section about creating/using `config.d/` for customizations
5. Anywhere it says "edit config.toml" for customization, redirect to config.d/ approach

**DAY1-OPERATIONS.md changes:**

1. Verify the immutable files paragraph was already updated (from earlier today). If not, fix: config files are NOT immutable, only binary/service/admin key are.
2. Verify config.d/ row exists in component table
3. Any "edit config.toml" instructions should point to config.d/ instead

**Commit:**
```bash
git add docs/INSTALL.md docs/DAY1-OPERATIONS.md
git commit -m "docs: fix INSTALL and DAY1 — config.toml not immutable, use config.d/"
```

---

### Task 3: CLAUDE.md

**Files:**
- Modify: `CLAUDE.md`

Read the current CLAUDE.md and update these sections:

1. **Module table:** Add `config_merge.rs` entry — "TOML config merge engine with _add/_remove list semantics for config.d/ overlay support"

2. **Module deep-dives:** Add a `### config_merge.rs` section explaining:
   - `merge_toml()` function: scalar override, recursive table merge, list _add/_remove
   - `strip_suffixes()`: cleanup after merge
   - Used by `Config::load_with_overrides()`

3. **config.rs section:** Document `Config::load_with_overrides()` — loads base config then merges config.d/*.toml overlays alphabetically

4. **policy.rs section:** Document:
   - `enabled` field on PolicyRule (default true)
   - `merge_rules()` method — name-based override
   - `load()` now sorts default.yaml first, merges by name
   - `PolicyFile` is now `pub(crate)`

5. **sentinel.rs section:** Document:
   - `handle_deletion()` — auto-restore from shadow on file deletion
   - `is_persistence_critical()` — detects systemd units, autostart, git hooks
   - `exclude_content_scan` field — substring-based exclusion
   - Scan deduplication (24h cooldown)

6. **behavior.rs section:** Document LD_PRELOAD env var detection in `classify_behavior()`

7. **barnacle.rs section:** Document compiler toolchain allowlist (build tool parent/binary suppression)

8. **Key patterns section:** Add note about config layering — config.d/ overrides, policy name-based merge

**Commit:**
```bash
git add CLAUDE.md
git commit -m "docs: CLAUDE.md — add config_merge, config layering, sentinel deletion/persistence"
```

---

### Task 4: SENTINEL.md + ARCHITECTURE.md

**Files:**
- Modify: `docs/SENTINEL.md`
- Modify: `docs/ARCHITECTURE.md`

**SENTINEL.md changes:**

1. Add section on **File Deletion Auto-Restore**: When a protected/watched file is deleted, sentinel detects the Remove event, restores from shadow copy if available, fires CRITICAL alert. Bypasses debounce for immediate response.

2. Add section on **Persistence-Critical Detection**: Sentinel flags certain file changes as persistence attempts:
   - `.service`/`.timer` files in `~/.config/systemd/user/` → CRIT with "PERSISTENCE:" prefix
   - `.desktop` files in `~/.config/autostart/` → CRIT
   - Non-`.sample` files in `.git/hooks/` → CRIT

3. Add section on **Content Scan Exclusions**: Two mechanisms:
   - Glob-based: `content_scan_excludes` (e.g. `**/.openclaw/**/auth-profiles.json`)
   - Substring-based: `exclude_content_scan` (e.g. `superpowers/skills`)

4. Add section on **Scan Deduplication**: Same category+status results are suppressed for 24 hours to reduce noise. Status changes still fire immediately.

**ARCHITECTURE.md changes:**

1. Add config layering to the data flow: base config.toml → config.d/*.toml overlays → merged Config struct
2. Add policy layering to the data flow: default.yaml → user *.yaml → name-based merge → PolicyEngine
3. Note that config.toml is no longer immutable

**Commit:**
```bash
git add docs/SENTINEL.md docs/ARCHITECTURE.md
git commit -m "docs: SENTINEL deletion/persistence/exclusions, ARCHITECTURE config layering"
```

---

### Task 5: SOURCE-INVENTORY.md

**Files:**
- Modify: `docs/SOURCE-INVENTORY.md`

Regenerate the public items inventory from current source. Run:

```bash
cd /home/openclaw/.openclaw/workspace/projects/ClawTower
grep -rn "^pub " src/*.rs src/**/*.rs 2>/dev/null | grep -v target | grep -v test | sort
```

Update the inventory with:
- All public structs, enums, functions, methods
- New modules: `config_merge.rs`, `firewall.rs`, `journald.rs`, `logtamper.rs`, `cognitive.rs`
- New public items in existing modules (e.g. `merge_toml`, `Config::load_with_overrides`, `PolicyEngine::merge_rules`, `Sentinel::handle_deletion`, `Sentinel::is_persistence_critical`)
- Update the "Last updated" date to 2026-02-16

**Commit:**
```bash
git add docs/SOURCE-INVENTORY.md
git commit -m "docs: regenerate SOURCE-INVENTORY from current source"
```

---

### Task 6: SECURITY-SCANNERS.md + ALERT-PIPELINE.md + CONFIGURATION.md

**Files:**
- Modify: `docs/SECURITY-SCANNERS.md`
- Modify: `docs/ALERT-PIPELINE.md`
- Modify: `docs/CONFIGURATION.md`

**SECURITY-SCANNERS.md changes:**

1. Line ~113: Update immutability scanner description — config.toml is no longer expected to be immutable. The scanner should check binary and service file, NOT config.toml. Update the "checks" list and remediation accordingly.

**ALERT-PIPELINE.md changes:**

1. Line ~361: Remove or update the chattr -i → write → chattr +i dance description for config editing. Config is now plain files, no immutable flag dance needed. Reference config.d/ instead.

**CONFIGURATION.md changes:**

1. Verify the config layering section (added earlier today) is accurate and complete
2. Make sure the field reference section below it is still accurate
3. Add `config_merge` to any module cross-references
4. Verify all config examples use `/etc/clawtower/` paths (not `/etc/clawav/`)

**Commit:**
```bash
git add docs/SECURITY-SCANNERS.md docs/ALERT-PIPELINE.md docs/CONFIGURATION.md
git commit -m "docs: fix chattr refs in SCANNERS/PIPELINE, verify CONFIGURATION accuracy"
```
